# iOS端APP埋点SDK方案整理
##### 由于项目越来越大复杂度越来越高，对项目的代码整理与分类对于开发来说是非常重要的，所以提前进行了iOS基础库建设进行了探索，此次对项目的埋点方案进行了探索与剖析。整理成文档，以供大家学习与交流。        

通过对当前主流项目方案分析调研发现目前常用的埋点技术方案大致分三种   
1、手动代码埋点方案     
2、无痕埋点方案(全埋点)     
3、可视化埋点方案       
下面就以上三种进行简单的介绍

## 方案选型    
##### 一、代码埋点方案 >  
简述：手动编写埋点代码在合适的时机，插入到合适的业务逻辑中。

实现    
1、手动编写统计的代码逻辑一个个地插入到需要统计的类和方法中去。工作量大，可维护性差，仅适用统计埋点极少的情况。        
2、通过继承和重写系统方法 -- 利用写好统计的一个基类，让需要VC继承自该基类，或者调用重写过统计逻辑的按钮基类等等。      
3、简单的分类，添加类方法或者示例方法 -- 将统计逻辑封装在分类方法里面，在需要统计的地方导入并调用分类方法。

代码示例    

```
[CAIStatistics event:@"redpacket_click" label:@"打卡成功-领取VIP"];
```

**优点**
+ 用起来比较简单，在收集个性化数据时也比较灵活  

**缺点** 
+ 新增埋点依赖App发版，影响数据收集时机。
+ App发版需要埋点工作完成，影响版本进度。
+ 埋点代码和业务代码耦合在一起，增加代码维护难度。
+ 如果埋点错误只能更新版本解决（Apple在2017年初全面禁止使用HotFix来修复bug）。

##### 二、无痕埋点方案 >  
简述：整体采用了 AOP（Aspect-Oriented-Programming）即面向切面编程的思想，就是动态的在函数调用的前后插入数据收集的代码，从而在hook方法中进行统一的埋点处理。  
例如在 Objective-C 中的实现是基于 Runtime 特性的 Method Swizzling 方式。        


实现    
1、替换系统方法的分类：通过运行时Runtime的办法 -- 利用Method Swizzling机制进行方法替换：替换原来的需要在里面统计却不含统计逻辑的方法 为 新的包含了统计逻辑的方法。      
2、通过AOP(面向切片编程)的工具类 -- 利用第三方Aspect框架对需要进行统计的方法进行挂钩（hook），并注入包含了统计逻辑的代码块（block)。

优点
+ 前端代码可移植程度高。
+ 完全无侵入统计，业务代码不受影响。
+ 因为这种方式是全统计，所以不存在动态化了根本就，后面业务只要摘取需要的内容就可以，数据量充足。 

缺点        
+ 需要后台配合，前端业务量少了，但是后台的业务量没有减少，需要共同维护。

##### 三、可视化埋点方案 >             
简述：埋点负责人通过APP可视化工具圈选具体页面元素并生成配置上报服务器，APP在启动后下发到APP端，在用户操作时，自动根据配置判断是否需要采集该事件。

优点
+ 对于数据运营来说是，非常好的数据运营工具，随时根据运营需求增加埋点事件。        

缺点        
+ APP端与后端都需要都读大量的精力去开发圈选工具和后端配置。
+ 复杂业务逻辑的精确打点需求无法满足。


##### 方案制定        
目前项目中依赖于纯手动的代码埋点，可以满足目前需求，埋点量不大也不小，就目前的情况来看出现了一下两点问题。    
1、出现了部分版本对埋点错误，测试未完全测出的情况   
2、新增埋点或着急收集的数据仍需发版收集时机受限。



通过对项目分析，以及市场主流方案的分析我做了以下项目模块的优化建议。

1、改善现有的统计模块，对目前的埋点模块类进行改善、抽象，虽然现在以友盟作为数据收集工具，但是以后难免要开发自己的后台数据库。另外目前手动代码埋点的方式需保留。    
2、增加无痕埋点模块，hook大部分常用类的方法根据数据收集需求来制定打点上报条件。

期望        
增加无痕埋点模块后可扩展服务器打点条件控制的能力，如服务器有机会能扩展埋点控制系统，可与安卓端商讨进行服务器控制埋点详细方案。

目前可视化埋点也是基于服务器统一的埋点配置上传与下发，如上一步比较完善后可进行下一步可视化埋点。


没有一种方案能完全解决所有的需求，目前大厂也是大致由70%的无痕埋点 + 30%手动埋点来解决埋点需求的。
咱们也是应该根据目前项目状态来确定具体该实施的方案



##### 参考技术资料    
[京东团队可视化埋点方案](https://mp.weixin.qq.com/s/u-HmmrSAgtER1N2pKxCm0A)       
[iOS打点方案设计](https://www.jianshu.com/p/815694614b2f)     
[网易乐得iOS无埋点数据SDK实践之路](https://www.jianshu.com/p/69ce01e15042 )       
[美团前端无痕埋点方案]( https://tech.meituan.com/mt_mobile_analytics_practice.html)
